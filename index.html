<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‹¤ì‹œê°„ ë§ˆìŠ¤í¬ ê°ì§€ ì‹œìŠ¤í…œ</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>
    <style>
        body { font-family: 'Pretendard', sans-serif; text-align: center; background: #f8f9fa; margin: 0; padding: 20px; }
        .app-card { max-width: 450px; margin: 0 auto; background: white; border-radius: 20px; padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        #webcam-container { width: 100%; border-radius: 15px; overflow: hidden; transform: rotateY(180deg); background: #000; margin-bottom: 20px; }
        canvas { width: 100% !important; height: auto !important; }
        .status-box { padding: 20px; border-radius: 15px; font-size: 1.4rem; font-weight: bold; margin-bottom: 20px; }
        .on { background: #e3f9e5; color: #1f9d55; border: 2px solid #1f9d55; }
        .off { background: #fff0f0; color: #e74c3c; border: 2px solid #e74c3c; }
        .wait { background: #f1f3f5; color: #868e96; }
        button { width: 100%; padding: 18px; font-size: 1.2rem; font-weight: bold; background: #0984e3; color: white; border: none; border-radius: 12px; cursor: pointer; }
        .debug-log { background: #333; color: #00ff00; padding: 10px; border-radius: 10px; font-family: monospace; font-size: 0.9rem; text-align: left; margin-top: 15px; }
    </style>
</head>
<body>

<div class="app-card">
    <h2>ë§ˆìŠ¤í¬ AI ì‹¤ì‹œê°„ ê°ì§€</h2>
    <div id="webcam-container"></div>
    <div id="status-display" class="status-box wait">ë²„íŠ¼ì„ ëˆŒëŸ¬ ì‹œì‘í•˜ì„¸ìš”</div>
    <button id="start-btn" onclick="init()">AI íƒì§€ ì‹œì‘</button>
    <div id="debug-log" class="debug-log">ì¸ì‹ ê²°ê³¼ ëŒ€ê¸° ì¤‘...</div>
</div>

<script>
    // ğŸ”— ë³¸ì¸ì˜ ëª¨ë¸ URL (í˜„ì¬ ì£¼ì†Œ ê·¸ëŒ€ë¡œ ìœ ì§€)
    const URL = " https://teachablemachine.withgoogle.com/models/IeC1nOM0j/";

    let model, webcam;
    let isRunning = false;

    // ìŒì„± ì•ˆë‚´ í•¨ìˆ˜ (ì´ì „ ìŒì„±ì„ ì¦‰ì‹œ ì·¨ì†Œí•˜ê³  ìƒˆë¡œ ë§í•¨)
    function speak(text) {
        window.speechSynthesis.cancel(); // ê²¹ì¹¨ ë°©ì§€
        const msg = new SpeechSynthesisUtterance(text);
        msg.lang = 'ko-KR';
        msg.rate = 1.1; // ì•½ê°„ ë¹ ë¥´ê²Œ ì„¤ì •
        window.speechSynthesis.speak(msg);
    }

    async function init() {
        if (isRunning) return; // ì´ë¯¸ ì‹¤í–‰ ì¤‘ì´ë©´ ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€
        
        const btn = document.getElementById("start-btn");
        btn.disabled = true;
        btn.innerText = "ì‹œìŠ¤í…œ ì‘ë™ ì¤‘...";

        try {
            model = await tmImage.load(URL + "model.json", URL + "metadata.json");
            
            webcam = new tmImage.Webcam(400, 400, true);
            await webcam.setup({ facingMode: "user" });
            await webcam.play();
            
            // í•µì‹¬: ê¸°ì¡´ í™”ë©´ì„ ë¹„ìš°ê³  í•˜ë‚˜ë§Œ ì¶”ê°€í•˜ì—¬ ì¤‘ë³µ ë°©ì§€
            const container = document.getElementById("webcam-container");
            container.innerHTML = ""; 
            container.appendChild(webcam.canvas);
            
            isRunning = true;
            window.requestAnimationFrame(loop);
        } catch (e) {
            alert("ì—ëŸ¬ ë°œìƒ: " + e.name + " - " + e.message);
            btn.disabled = false;
        }
    }

    async function loop() {
        if (!isRunning) return;
        webcam.update();
        await predict();
        window.requestAnimationFrame(loop);
    }

    async function predict() {
        const prediction = await model.predict(webcam.canvas);
        const statusDiv = document.getElementById("status-display");
        const debugDiv = document.getElementById("debug-log");

        let debugText = "ğŸ” <b>í˜„ì¬ ì¸ì‹:</b><br>";
        let topClass = "";
        let topProb = 0;

        for (let i = 0; i < prediction.length; i++) {
            const prob = (prediction[i].probability * 100).toFixed(0);
            debugText += `${prediction[i].className}: ${prob}%<br>`;
            if (prediction[i].probability > topProb) {
                topProb = prediction[i].probability;
                topClass = prediction[i].className;
            }
        }
        debugDiv.innerHTML = debugText;

        // 80% ì´ìƒì˜ í™•ì‹ ì´ ìˆì„ ë•Œ ì‘ë™
        if (topProb > 0.8) {
            // ì‚¬ìš©ìë‹˜ì˜ ëª¨ë¸ í´ë˜ìŠ¤ ì´ë¦„ 'ë§ˆìŠ¤í¬'ì™€ 'ë…¸ë§ˆìŠ¤í¬'ì— ë§ê²Œ ìˆ˜ì •ë¨
            if (topClass === "ë§ˆìŠ¤í¬") {
                statusDiv.innerText = "âœ… í™˜ì˜í•©ë‹ˆë‹¤!";
                statusDiv.className = "status-box on";
                // ë§í•˜ê¸°ê°€ ì§„í–‰ ì¤‘ì´ì§€ ì•Šì„ ë•Œë§Œ ì‹¤í–‰í•˜ì—¬ ë¬´í•œ ë°˜ë³µ
                if (!window.speechSynthesis.speaking) speak("í™˜ì˜í•©ë‹ˆë‹¤");
            } else if (topClass === "ë…¸ë§ˆìŠ¤í¬") {
                statusDiv.innerText = "âŒ ë§ˆìŠ¤í¬ë¥¼ ì¨ì£¼ì„¸ìš”!";
                statusDiv.className = "status-box off";
                if (!window.speechSynthesis.speaking) speak("ë§ˆìŠ¤í¬ë¥¼ ì“°ê³  ì…ì¥í•´ì£¼ì„¸ìš”");
            }
        }
    }
</script>
</body>

</html>
